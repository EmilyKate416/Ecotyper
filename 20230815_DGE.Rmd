---
title: "DGE"
output: html_document
date: "2023-08-15"
---


```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

- based on DGE script from Ashley Weir 

## Data required:
- *20230815_STARcounts_TCGAOV.tsv* produced in temp_GDC_download_serverversion.Rmd 
 - meta data from TCGA download *20230815_clinical.csv*
- location on jblab server002: /home/lythgo02/ecotyper/20230720_TCGA_2nd_year/GDCdata/ 
- contrast labels *20230815_ST_58_Clinical_data_TCGA-OV_contrast_groups.tsv* produced in 20230725_TCGA_OV_stratification.Rmd 
- location on I-drive: ./Data/Processed/


```{r, message=FALSE, warning=FALSE}
setwd("/research/jblab/data/group_folders/emily_lythgoe/20230724_EcoTyper_2nd_year/")

library(dplyr)
library(tidyverse)
library(ggplot2)
library(stringr)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(limma)
library(edgeR)
library(DESeq2)
library(janitor)
```

**load data**

```{r, message=FALSE}

rawCounts <- read_delim("Y:/ecotyper/20230720_TCGA_2nd_year/GDCdata/20230815_STARcounts_TCGAOV.tsv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)

meta <- read_csv("Y:/ecotyper/20230720_TCGA_2nd_year/GDCdata/20230815_clinical.csv")

#need to check for the most recent version of the pan-cancer clinical data table (modified to contrast contrast labels in Rmd 20230725_TCGA_OV_stratification.Rmd on I drive
pancan_contrasts <-  read_delim("Data/Processed/20230815_ST_58_Clinical_data_TCGA-OV_contrast_groups.tsv", 
                        delim = "\t", escape_double = FALSE, trim_ws = TRUE) %>% 
                        dplyr::rename(submitter_id = name) %>%
                        mutate(submitter_id = str_trunc(submitter_id, 12, "right", ellipsis = "")) # some samples have additional letters at the end (unsure if this is vial number), remove these letters from name
```

**Wrangle data**

```{r wrangle data}

# make ID column rownames
rawCounts <- rawCounts %>% 
  column_to_rownames(var = "gene_id") #430 cases with RNAseq counts from GDC



#get list of IDs you need the metadata for (all those with RNAseq counts)
#note we have more than one sequencing file for some individuals eg TCGA-61-2008-01A and TCGA-61-2008-02A, the last number in the sequence indicates the sample type, 01 is a primary tumour and 02 is a recurring tumour (see GDC sample type codes)
#filter to include only primary tumours
primary_samples <- as.data.frame(colnames(rawCounts)) %>% 
   str_trunc(16, "right", ellipsis = "") %>% 
  clean_names() %>% 
  dplyr::rename(submitter_id = colnames_raw_counts) %>% 
  filter(!str_detect(submitter_id,"02A")) %>% 
  str_trunc(12, "right", ellipsis = "") # TCGA-23-1023 is present twice as TCGA-23-1023-01A and TCGA-23-1023-01R, so is appears duplicated when truncated


#filtered_pancan <- left_join(primary_samples, pancan_contrasts) 

# pull out cases not present in the pancancer table
#cases_missing_labels <- filtered_pancan %>% 
 # filter(is.na(cx3)) %>% 
 # dplyr::select(submitter_id) %>% 
 # write_delim("./Data/Processed/20230815_rnaseq_cases_missing_from_pancan.tsv", delim = "\t")

```

```{r, message=FALSE}
#reload the cases_missing_labels list annotated using Wang 2017 and Takaya 2020 annotation
cases_missing_labels <- read_csv("Data/Processed/20230815_rnaseq_cases_missing_from_pancan.csv")

pancan_contrasts_shortened <- pancan_contrasts %>% 
  dplyr::select("submitter_id", "contrast_group") #only need the contrast info for now
 
meta_plus_contrast <- cases_missing_labels %>% 
  dplyr::select("submitter_id", "contrast_group") %>% 
  full_join(meta)

# add in the contrast group info from cases_missing_labels into meta_plus_contrast group

meta_plus_contrast <- meta_plus_contrast %>%  
  left_join(pancan_contrasts_shortened, by = ("submitter_id")) %>%  
  mutate(contrast_group = if_else(is.na(contrast_group.y), contrast_group.x, contrast_group.y)) %>% 
  dplyr::select(-contrast_group.x, -contrast_group.y)
#mutate line: the left_join merges the two tables by ID but keeps both contrast columns (renamed as contrast_group.y and contrast_group.x). The mutate creates a new column contrast_group, checks for NA in the contrast_group.y column and enters the value of the contrast_group.x column in the new contrast_group column if it is NA, otherwise it enters the value in the conrast_group.y column. 

#note if using if_else() from dplyr, use | and & as comparison operators, but if using if and else from base r, use || and && as comparison operators

 tabyl(meta_plus_contrast$contrast_group)
```

**Annotate genes.**

```{r geneAnnotation}
 # Human Ensembl/GENCODE gene accession numbers start with ENSG followed by a number and version number separated by a dot. 
ensembl <- data.frame(ensembl_id = rownames(rawCounts)) %>%  #create a data frame with a column for row names
  separate(ensembl_id, into = c("ensembl_id", "version_number"), sep="\\.")  #escape the dot in sep argument using \\. because the dot is a special character

ensembl_id <- as.character(ensembl$ensembl_id) # don't need version number for now, keys must be provided as character 


colGene <- c("ENTREZID", "SYMBOL", "GENETYPE", "ENSEMBL") #defines the columns you want to select from the gene annotation database

geneIdMap <- AnnotationDbi::select(org.Hs.eg.db, #the org.Hs.eg.db package provides annotations for the human genome
                                       keys = ensembl_id, 
                                       columns = colGene, keytype = "ENSEMBL") #queries the org.Hs.eg.db gene annotation database using the Ensembl Gene IDs as keys. It retrieves the specified columns (colGene) for the provided gene IDs (gene_id) using the specified key type (ENSEMBL).

count(is.na(geneIdMap$ENTREZID)) # 24622 don't match to an ID
duplicated_geneIdMap <- geneIdMap %>% 
  filter(duplicated(ENTREZID) &!is.na(ENTREZID)) #2812 duplicated ID

#remove duplicated rows from the geneIdMapExAn data frame based on the ENTREZID column (retaining one copy of any duplicated name)
geneIdMap <- geneIdMap[!duplicated(geneIdMap$ENTREZID), ]

geneIdMap <- geneIdMap[geneIdMap$ENSEMBL %in% ensembl_id, ] 
geneIdMap <- geneIdMap[complete.cases(geneIdMap), ] # one gene has missing entries, remove

meta_rawCounts_matched <- meta_plus_contrast[meta_plus_contrast$submitter_id %in% primary_samples$submitter_id,] #have metadata for 421 out of 423 primary samples 
genes <-  geneIdMap$ENSEMBL

#(question for Ash, is it normal to go from 60660 to 36639 rows of gene expression data after gene annotation?)

```

**Create matrix of read counts.**

```{r}

rawCountsCleaned <- as.matrix(rawCounts[genes, ]) %>% # filters the raw count data for genes that match the annotated expression data and converts to a matrix 
  apply( 2, function(x) as.numeric(trimws(x))) 
rownames(rawCountsCleaned) <- rownames(rawCounts[genes, ])

#apply(...) applies the function that removes leading spaces and converts values to numeric for each column of the filtered and converted matrix....
   #apply is used to apply a function to each column (indicated by '2')
   #the function is an anonymous function created using function(x) - Inside the function: trimws(x): removes leading and trailing white spaces from the character values in column x which are then converted to numbers.

```

**Create a DGE object for DE analysis.**

```{r dgeObject}
count(is.na(meta_rawCounts_matched$contrast_group)) #DGEList can't accept NA values

 meta_rawCounts_matched <- meta_rawCounts_matched %>% 
  mutate(contrast_group = if_else(is.na(contrast_group), "unknown", contrast_group)) #if NA in contrast_group, replace with "unknown", otherwise keep contrast_group entry


dge <- DGEList(counts = rawCountsCleaned, genes = geneIdMap_clean$ENTREZID, samples = meta_rawCounts_matched, group = meta_rawCounts_matched$contrast_group) 

#is it due to NA in the meta data?
```


